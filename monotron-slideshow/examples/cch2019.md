
## Embedded Rust and the

^RЫЫЫЫЫ^K ^R^yЫЫЫЫЫ^K^k ^YЫЫ  Ы^K ^GЫЫЫЫЫ^K ^G^yЫ^kЫ^yЫ^kЫЫ^K ^BЫЫЫЫ^K ^BЫЫЫЫЫ^K ^MЫЫ  Ы^W
^RІ^K ^RІ^K ^RІ^K ^R^yІ^K^k   ^R^yІ^K^k ^YІ^K ^YІ І^K ^GІ^K   ^GІ^K ^G ^K ^G^yІ^K^k ^G ^K ^B^gІ^K^k  ^B^gІ^K^k ^BІ^K   ^BІ^K ^MІ^K ^MІ І^W
^R±^K ^R±^K ^R±^K ^R^y±^K^k   ^R^y±^K^k ^Y±^K  ^Y±±^K ^G±^K   ^G±^K ^G ^K ^G^y±^K^k ^G ^K ^B^g±^K^k ^B^g±^k ^K ^B±^K   ^B±^K ^M±^K ^M ±±^W
^R° °^K ^R°^K ^R^y°°°°°^K^k ^Y°   °^K ^G°°°°°^K ^G  ^y°^k  ^K ^B^g°^k  ^g°^K^k ^B°°°°°^K ^M°   °^W

* Jonathan 'theJPster' Pallant
* Centre for Computing History, April 2019
---

## Preamble: Introductions

* @therealjpster (Twitter)
* @thejpster (Github)
* keybase.io/thejpster
---

## Preamble: What can I expect?

* A tale of obsession
* Right tool, to fix the wrong thing
---

## Agenda

* Act 1 - Embedded Rust <--
* Act 2 - The Idea
* Act 3 - The Implementation
* Act 4 - Spiralling out of control
* Act 5 - The Demo
---

                    ЫЫЫЫЫЫЫ
                 ЫЫЫЫЫЫ±ЫЫЫЫЫЫ
               ЫЫЫЫЫЫЫ±±±ЫЫЫЫЫЫЫ
              ЫЫЫЫЫЫ ЫЫ±ЫЫ ЫЫЫЫЫЫ
             ЫЫЫЫ     ЫЫЫ     ЫЫЫЫ
            ЫЫЫЫ       Ы       ЫЫЫЫ
           ЫЫЫЫ                 ЫЫЫЫ
          ЫЫЫЫ                   ЫЫЫЫ
          ЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫ      ЫЫЫ
         ЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫ      ЫЫЫ
         ЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫ     ЫЫЫ
         Ы±ЫЫЫЫЫЫЫЫ      ЫЫЫЫЫЫ   ЫЫ±Ы
        Ы±±±ЫЫ ЫЫЫЫ       ЫЫЫЫЫ  ЫЫ±±±Ы
        ЫЫ±ЫЫ  ЫЫЫЫ       ЫЫЫЫЫ   ЫЫ±ЫЫ
        ЫЫЫЫ   ЫЫЫЫ      ЫЫЫЫЫ     ЫЫЫЫ
        ЫЫЫ    ЫЫЫЫЫЫЫЫЫЫЫЫЫЫ       ЫЫЫ
        ЫЫЫ    ЫЫЫЫЫЫЫЫЫЫЫЫЫ        ЫЫЫ
        ЫЫЫ    ЫЫЫЫЫЫЫЫЫЫЫ          ЫЫЫ
        ЫЫЫ    ЫЫЫЫЫЫЫЫЫЫЫЫ         ЫЫЫ
         ЫЫЫЫЫЫЫЫЫЫ    ЫЫЫЫЫ     ЫЫЫЫЫ
         ЫЫЫЫЫЫЫЫЫЫ     ЫЫЫЫЫЫЫЫЫЫЫЫЫЫ
         ЫЫЫЫЫЫЫЫЫЫЫ     ЫЫЫЫЫЫЫЫЫЫЫЫЫ
          ЫЫЫ                ЫЫЫЫЫЫЫЫ
          ЫЫЫЫЫЫЫЫЫ          ЫЫЫЫЫЫЫЫ
           ЫЫЫЫЫ±ЫЫ          ЫЫ±ЫЫЫЫ
            ЫЫЫ±±±Ы          Ы±±±ЫЫ
             ЫЫЫ±ЫЫ          ЫЫ±ЫЫ
              ЫЫЫЫЫЫ       ЫЫЫЫЫЫ
               ЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫ
                 ЫЫЫЫЫЫЫЫЫЫЫЫЫ
                    ЫЫЫЫЫЫЫ
---
^B^k
    ^wЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫ       ЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫ^k
    ^wЫЫЫЫЫЫЫЫЫЫЫЫ      ±      ЫЫЫЫЫЫЫЫЫЫЫЫ^k
  Ы ^wЫЫЫЫЫЫЫЫЫЫ       ±±±       ЫЫЫЫЫЫЫЫЫЫ^k Ы
 ЫЫ ^wЫЫЫЫЫЫЫЫЫ      Ы  ±  Ы      ЫЫЫЫЫЫЫЫЫ^k ЫЫ
  Ы ^wЫЫЫЫЫЫЫЫ    ЫЫЫЫЫ   ЫЫЫЫЫ    ЫЫЫЫЫЫЫЫ^k Ы
    ^wЫЫЫЫЫЫЫ    ЫЫЫЫЫЫЫ ЫЫЫЫЫЫЫ    ЫЫЫЫЫЫЫ^k
  Ы ^wЫЫЫЫЫЫ    ЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫ    ЫЫЫЫЫЫ^k Ы
 ЫЫ ^wЫЫЫЫЫ                  ЫЫЫЫЫЫ   ЫЫЫЫЫ^k ЫЫ
  Ы ^wЫЫЫЫ                    ЫЫЫЫЫЫ   ЫЫЫЫ^k Ы
    ^wЫЫЫЫ                     ЫЫЫЫЫ   ЫЫЫЫ^k
  Ы ^wЫЫЫЫ ±        ЫЫЫЫЫЫ      ЫЫЫ  ± ЫЫЫЫ^k Ы
 ЫЫ ^wЫЫЫ ±±±  Ы    ЫЫЫЫЫЫЫ     ЫЫ  ±±± ЫЫЫ^k ЫЫ
  Ы ^wЫЫЫ  ±  ЫЫ    ЫЫЫЫЫЫЫ     ЫЫЫ  ±  ЫЫЫ^k Ы
    ^wЫЫЫ    ЫЫЫ    ЫЫЫЫЫЫ     ЫЫЫЫЫ    ЫЫЫ^k
  Ы ^wЫЫЫ   ЫЫЫЫ              ЫЫЫЫЫЫЫ   ЫЫЫ^k Ы
 ЫЫ ^wЫЫЫ   ЫЫЫЫ             ЫЫЫЫЫЫЫЫ   ЫЫЫ^k ЫЫ
  Ы ^wЫЫЫ   ЫЫЫЫ           ЫЫЫЫЫЫЫЫЫЫ   ЫЫЫ^k Ы
    ^wЫЫЫ   ЫЫЫЫ            ЫЫЫЫЫЫЫЫЫ   ЫЫЫ^k
  Ы ^wЫЫЫЫ          ЫЫЫЫ     ЫЫЫЫЫ     ЫЫЫЫ^k Ы
 ЫЫ ^wЫЫЫЫ          ЫЫЫЫЫ              ЫЫЫЫ^k ЫЫ
  Ы ^wЫЫЫЫ           ЫЫЫЫЫ             ЫЫЫЫ^k Ы
    ^wЫЫЫЫЫ   ЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫ   ЫЫЫЫЫ^k
  Ы ^wЫЫЫЫЫЫ     ±  ЫЫЫЫЫЫЫЫЫЫ  ±    ЫЫЫЫЫЫ^k Ы
 ЫЫ ^wЫЫЫЫЫЫЫ   ±±± ЫЫЫЫЫЫЫЫЫЫ ±±±  ЫЫЫЫЫЫЫ^k ЫЫ
  Ы ^wЫЫЫЫЫЫЫЫ   ±  ЫЫЫЫЫЫЫЫЫЫ  ±  ЫЫЫЫЫЫЫЫ^k Ы
    ^wЫЫЫЫЫЫЫЫЫ      ЫЫЫЫЫЫЫ      ЫЫЫЫЫЫЫЫЫ^k
  Ы ^wЫЫЫЫЫЫЫЫЫЫ                 ЫЫЫЫЫЫЫЫЫЫ^k Ы
 ЫЫ ^wЫЫЫЫЫЫЫЫЫЫЫЫ             ЫЫЫЫЫЫЫЫЫЫЫЫ^k ЫЫ
  Ы ^wЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫ       ЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫ^k Ы
    ^w±±±Ы±ЫЫЫ±Ы±±±ЫЫ±±±Ы±±±ЫЫ±±±ЫЫ±±±Ы±±±Ы^k
  Ы ^w±ЫЫЫ±±Ы±±Ы±ЫЫ±Ы±ЫЫЫ±ЫЫ±Ы±ЫЫ±Ы±ЫЫЫ±ЫЫ±^k Ы
 ЫЫ ^w±±±Ы±Ы±Ы±Ы±±±ЫЫ±±±Ы±ЫЫ±Ы±ЫЫ±Ы±±±Ы±ЫЫ±^k ЫЫ
  Ы ^w±ЫЫЫ±ЫЫЫ±Ы±ЫЫ±Ы±ЫЫЫ±ЫЫ±Ы±ЫЫ±Ы±ЫЫЫ±ЫЫ±^k Ы
    ^w±±±Ы±ЫЫЫ±Ы±±±ЫЫ±±±Ы±±±ЫЫ±±±ЫЫ±±±Ы±±±Ы^k
---
# Act 1: Rust 2018
---

## Act 1: Things you need for Embedded Rust

1. LLVM Backend
1. Target File
1. libcore
---

## Act 1: UART / GPIO Example

 // USB Serial UART
 ^Clet ^Ymut^W usb_uart = ^CSerial^W::uart0(
   p.UART0,
   porta.pa1.into_af_push_pull::<gpio::AF1>(
       ^Y&mut^W porta.control
   ),
   porta.pa0.into_af_push_pull::<gpio::AF1>(
       ^Y&mut^W porta.control
   ),
   (),
   (),
   115200_^Cu32^W.^Cbps^W(),
   ^CNewlineMode^W::^CSwapLFtoCR^W,
   ^Y&^Wclocks,
   ^Y&^Wsc.power_control
 );
---

## Act 1: Atomic Section / Closures Example

 ^Ypub^W ^Cfn^W free<F, R>(f: F) -> R
 ^Ywhere^W
     F: ^CFnOnce^W(&CriticalSection) -> R,
 {
     ^Clet^W primask ^Y=^W register::primask::read();
     ^Cdisable^W();
     ^Clet^W r = f(^Yunsafe^W {
         ^Y&^CCriticalSection^W::new()
     });
     ^Yif^W primask.is_active() {
         ^Yunsafe^W { enable() }
     }
     r
 }
---

## Act 1: Deref / Memory Mapped I/O Example

 ^Cimpl^W CBP {

   ^Ypub^W (^Ycrate^W) ^Yunsafe^W ^Cfn^W new() -> Self {
       CBP {
           _marker: ^CPhantomData^W
       }
   }

   ^Ypub^W ^Cfn^W ptr() -> ^Y*const^W RegisterBlock {
       0xE000_EF50 ^Yas *const _^W
   }

 }

 ^Cimpl^W ops::Deref ^Yfor^W CBP {
     type Target = ^CRegisterBlock^W;

     ^Cfn^W deref(&self) -> ^Y&^CSelf^W::Target {
         ^Yunsafe^W { ^Y&*^CSelf^W::ptr() }
     }

 }
---

## Act 1: Creating a new Project

* cargo new my_project
* Clone rust-embedded/cortex-m-quickstart
* cargo generate
---

## Act 1: Adding a HAL crate

* Hardware Abstraction Layer
* Some crates will Use the HAL...
* ^Cfn^W new(spi: S) ^Cwhere^W S: spi::FullDuplex
* Some crates will Impl the HAL...
* ^Cimpl^W spi::FullDuplex ^Cfor^W TivaSPI {...}
* Serial Ports, I2C, SPI, Timers, etc.
---

## Act 1: Running Embedded code on an OS

* Anyone can impl the Hal...
* impl spi::FullDuplex for LinuxDev {...}
* #[cfg(feature)] macros
---

## Agenda

* Act 1 - Embedded Rust
* Act 2 - The Idea <--
* Act 3 - The Implementation
* Act 4 - Spiralling out of control
* Act 5 - The Demo
---

## Act 2: The Commodore 64
^C
^bЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫ^k
^bЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫ^k
^bЫЫЫ                                        ЫЫЫ^k
^bЫЫЫ    **** COMMODORE 64 BASIC V2 ****     ЫЫЫ^k
^bЫЫЫ                                        ЫЫЫ^k
^bЫЫЫ 64K RAM SYSTEM  38911 BASIC BYTES FREE ЫЫЫ^k
^bЫЫЫ                                        ЫЫЫ^k
^bЫЫЫREADY.                                  ЫЫЫ^k
^bЫЫЫ10 FOR X = 1 TO 5                       ЫЫЫ^k
^bЫЫЫ20 PRINT "HELLO CCH"                    ЫЫЫ^k
^bЫЫЫ30 NEXT                                 ЫЫЫ^k
^bЫЫЫRUN                                     ЫЫЫ^k
^bЫЫЫHELLO CCH                               ЫЫЫ^k
^bЫЫЫHELLO CCH                               ЫЫЫ^k
^bЫЫЫHELLO CCH                               ЫЫЫ^k
^bЫЫЫHELLO CCH                               ЫЫЫ^k
^bЫЫЫHELLO CCH                               ЫЫЫ^k
^bЫЫЫ                                        ЫЫЫ^k
^bЫЫЫ                                        ЫЫЫ^k
^bЫЫЫ                                        ЫЫЫ^k
^bЫЫЫ                                        ЫЫЫ^k
^bЫЫЫ                                        ЫЫЫ^k
^bЫЫЫ                                        ЫЫЫ^k
^bЫЫЫ                                        ЫЫЫ^k
^bЫЫЫ                                        ЫЫЫ^k
^bЫЫЫ                                        ЫЫЫ^k
^bЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫ^k
^bЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫ^k
---

## Act 2: Less is More

* For Sale: Baby shoes, never worn
---

## Act 2: Goals for the project

* To distract me...
* Can you generate video with Rust?
* How much can you squeeze from one chip?
---

## Act 2: Candidate 1 - STM32F7 Discovery

* Cortex-M7 @ 216 MHz
* 1 MiB Flash
* 340 KiB SRAM
* Audio, Ethernet, SD/MMC
* Has a TFT controller...
* About њ50
---

## STM32F7 Discovery

 ^GЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫ
 ^GЫ^WЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫ^GЫ
 ^GЫ^WЫ                                        Ы^GЫ
 ^GЫ^WЫ                                        Ы^GЫ
 ^GЫ^WЫ  ^YЫЫЫЫ ЫЫЫЫЫ Ы   Ы ЫЫЫЫ ЫЫЫЫ ЫЫЫ ЫЫЫЫ   ^WЫ^GЫ
 ^GЫ^WЫ  ^YЫ      Ы   ЫЫ ЫЫ    Ы    Ы Ы      Ы   ^WЫ^GЫ
 ^GЫ^WЫ  ^YЫЫЫЫ   Ы   Ы Ы Ы  ЫЫЫ ЫЫЫЫ ЫЫЫ    Ы   ^WЫ^GЫ
 ^GЫ^WЫ     ^YЫ   Ы   Ы   Ы    Ы Ы    Ы      Ы   ^WЫ^GЫ
 ^GЫ^WЫ  ^YЫЫЫЫ   Ы   Ы   Ы ЫЫЫЫ ЫЫЫЫ Ы      Ы   ^WЫ^GЫ
 ^GЫ^WЫ                                        Ы^GЫ
 ^GЫ^WЫ                                        Ы^GЫ
 ^GЫ^WЫ                                        Ы^GЫ
 ^GЫ^WЫ ^YЫЫЫ  Ы ЫЫЫ ЫЫЫ ЫЫЫЫ Ы   Ы ЫЫЫ ЫЫЫЫ Ы Ы ^WЫ^GЫ
 ^GЫ^WЫ ^YЫ ЫЫ Ы Ы   Ы   Ы  Ы Ы   Ы Ы   Ы  Ы Ы Ы ^WЫ^GЫ
 ^GЫ^WЫ ^YЫ ЫЫ Ы ЫЫЫ Ы   Ы  Ы  Ы Ы  ЫЫЫ ЫЫЫЫ Ы Ы ^WЫ^GЫ
 ^GЫ^WЫ ^YЫ ЫЫ Ы   Ы Ы   Ы  Ы  Ы Ы  Ы   Ы Ы   Ы  ^WЫ^GЫ
 ^GЫ^WЫ ^YЫЫЫ  Ы ЫЫЫ ЫЫЫ ЫЫЫЫ   Ы   ЫЫЫ Ы  Ы  Ы  ^WЫ^GЫ
 ^GЫ^WЫ                                        Ы^GЫ
 ^GЫ^WЫ                                        Ы^GЫ
 ^GЫ^WЫ                                        Ы^GЫ
 ^GЫ^WЫ                                        Ы^GЫ
 ^GЫ^WЫ                                        Ы^GЫ
 ^GЫ^WЫ                                        Ы^GЫ
 ^GЫ^WЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫ^GЫ
 ^GЫЫЫЫЫ^CЫЫЫЫ^GЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫ
 ^GЫЫЫЫЫ^CЫЫЫЫ^GЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫ
      ^CЫЫЫЫ     ЫЫЫЫ                ЫЫЫЫ
---

## Act 2: Candidate 2 - Stellaris Launchpad

* Cortex-M4 @ 80 MHz
* 256 KiB Flash
* 32 KiB SRAM
* I2C, UART, SPI
* About њ12
* There was one on my desk
---
          ^WЬЬЬ^R
     ЫЫЫЫЫ^W^rЯЯЯ^R^kЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫ
     ЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫ
     ЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫ
     ЫЫЫЫЫЫЫЫЫ      ЫЫЫЫЫЫЫЫЫЫЫЫЫЫ
    ^WЫ^RЫЫЫЫЫЫЫЫЫ      ЫЫЫЫЫЫЫЫЫЫЫЫЫЫ
    ^WЫ^RЫЫЫЫЫЫЫЫЫ ^WTM4C ^RЫЫЫЫЫЫЫЫЫЫЫЫЫЫ
    ^WЫ^RЫЫЫЫЫЫЫЫЫ ^W123G ^RЫЫЫЫЫЫЫЫЫЫЫЫЫЫ
     ЫЫЫЫЫЫЫЫЫ      ЫЫЫЫЫЫЫЫЫЫЫЫЫЫ
     ЫЫЫЫЫЫЫЫЫ      ЫЫЫЫЫЫЫЫЫЫЫЫЫЫ
     ЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫ
     ЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫ
     ЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫ
     ЫЫЫЫЫЫЫ^Y^rooooo^R^kЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫ
     ЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫ
     ЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫ
     ЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫ
     ЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫ
     ЫЫЫЫЫЫЫЫЫЫЫЫЫЫ^K^wЫ^R^kЫЫЫЫЫЫЫЫЫЫЫЫЫЫ
     ЫЫ^Y^rOO^R^kЫЫЫЫЫЫЫЫЫ^K^wЫ^kЫ^wЫ^R^kЫЫЫЫЫЫЫЫЫ^Y^rOO^R^kЫЫ
     ЫЫ^Y^rOO^R^kЫЫЫЫЫЫЫЫ^K^wЫ^kЫЫЫ^wЫ^R^kЫЫЫЫЫЫЫЫ^Y^rOO^R^kЫЫ
     ЫЫ^Y^rOO^R^kЫЫЫЫЫЫЫ^K^wЫ^W^kTM4C^KЫ^wЫ^R^kЫЫЫЫЫЫЫ^Y^rOO^R^kЫЫ
     ЫЫ^Y^rOO^R^kЫЫЫЫЫЫ^K^wЫ^kЫ^W 123G^KЫ^wЫ^R^kЫЫЫЫЫЫ^Y^rOO^R^kЫЫ
     ЫЫ^Y^rOO^R^kЫЫЫЫЫЫЫ^K^wЫ^R^k     ^K^wЫ^R^kЫЫЫЫЫЫЫ^Y^rOO^R^kЫЫ
     ЫЫ^Y^rOO^R^kЫЫЫЫЫЫЫЫ^K^wЫ^R^k   ^K^wЫ^R^kЫЫЫЫЫЫЫЫ^Y^rOO^R^kЫЫ
     ЫЫ^Y^rOO^R^kЫЫЫЫЫЫЫЫЫ^K^wЫ^R^k ^K^wЫ^R^kЫЫЫЫЫЫЫЫЫ^Y^rOO^R^kЫЫ
     ЫЫ^Y^rOO^R^kЫЫЫЫЫЫЫЫЫЫ^K^wЫ^R^kЫЫЫЫЫЫЫЫЫЫ^Y^rOO^R^kЫЫ
     ЫЫ^Y^rOO^R^kЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫ^Y^rOO^R^kЫЫ
     ЫЫ^Y^rOO^R^kЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫ^Y^rOO^R^kЫЫ
     ЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫ
     ЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫ
     ЫЫЫЫЫ^WЫЫЫ^RЫЫЫЫЫЫЫЫЫЫЫЫЫ^WЫЫЫ^RЫЫЫЫЫ
     ЫЫЫЫЫ^WЫ Ы^RЫЫЫЫЫЫЫЫЫЫЫЫЫ^WЫ Ы^RЫЫЫЫЫ
     ЫЫЫЫЫ^WЫЫЫ^RЫЫЫЫЫЫЫЫЫЫЫЫЫ^WЫЫЫ^RЫЫЫЫЫ
     ЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫЫ
---

## Act 2: Generating Analog Video
^e
 ^WЙНННННННННННННННННННННННННННН»^R±±±±
 ^Wє^B±±±±±±±±±±±±±±±±±±±±±±±±±±±±^Wє^R±±±±
 ^Wє^B±±±±±±±±±±±±±±±±±±±±±±±±±±±±^Wє^R±±±±
 ^Wє^B±±±±±±±±±±±±±±±±±±±±±±±±±±±±^Wє^R±^WH^R±±
 ^Wє^bДДДДДДДДДДДДДДДДДДДДДДДДДДДД^kє^R±^Wo^R±±
 ^Wє^B±±±±±±±±±±±±±±±±±±±±±±±±±±±±^Wє^R±^Wr^R±±
 ^Wє^bДДДДДДДДДДДДДДДДДДДДДДДДДДДД^kє^R±^Wi^R±±
 ^Wє^B±±±±±±±±±±±±±±±±±±±±±±±±±±±±^Wє^R±^Wz^R±±
 ^Wє^bДДДДДДДДДДДДДДДДДДДДДДДДДДДД^kє^R±^Wo^R±±
 ^Wє^B±±±±±±±±±±±±±±±±±±±±±±±±±±±±^Wє^R±^Wn^R±±
 ^Wє^B±±±±±±±±±±±±±±±±±±±±±±±±±±±±^Wє^R±^Wt^R±±
 ^Wє^B±±±±±±±±±±±±±±±±±±±±±±±±±±±±^Wє^R±^Wa^R±±
 ^Wє^B±±±±±±±±±±±±±±±±±±±±±±±±±±±±^Wє^R±^Wl^R±±
 ^Wє^B±±±±±±±±±±±±±±±±±±±±±±±±±±±±^Wє^R±±±±
 ^Wє^B±±±±±±±±±±±±±±±±±±±±±±±±±±±±^Wє^R±^WB^R±±
 ^Wє^B±±±±±±±±±±±±±±±±±±±±±±±±±±±±^Wє^R±^Wl^R±±
 ^Wє^B±±±±±±±±±±±±±±±±±±±±±±±±±±±±^Wє^R±^Wa^R±±
 ^Wє^B±±±±±±±±±±±±±±±±±±±±±±±±±±±±^Wє^R±^Wn^R±±
 ^Wє^B±±±±±±±±±±±±±±±±±±±±±±±±±±±±^Wє^R±^Wk^R±±
 ^Wє^B±±±±±±±±±±±±±±±±±±±±±±±±±±±±^Wє^R±^Wi^R±±
 ^Wє^B±±±±±±±±±±±±±±±±±±±±±±±±±±±±^Wє^R±^Wn^R±±
 ^Wє^B±±±±±±±±±±±±±±±±±±±±±±±±±±±±^Wє^R±^Wg^R±±
 ^Wє^B±±±±±±±±±±±±±±±±±±±±±±±±±±±±^Wє^R±±±±
 ^Wє^B±±±±±±±±±±±±±±±±±±±±±±±±±±±±^Wє^R±±±±
 ^Wє^B±±±±±±±±±±±±±±±±±±±±±±±±±±±±^Wє^R±±±±
 ^WИННННННННННННННННННННННННННННј^R±±±±
 ^G±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
 ±±±±±±±^WVertical blanking^G±±±±±±±±±±
 ±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±±
---

## Act 2: VGA Timing

* tinyvga.com/vga-timing
* 640 x 480 @ 60 Hz = 25.175 MHz
* 720 x 400 @ 70 Hz = 28.322 MHz
* 800 x 600 @ 60 Hz = 40.000 MHz
---

## Act 2: Rendering Mono/RGB Bitmaps

* Mono analog video
          Ъ----------------------ї
          і                      і
          і                      і
 ДДї   ЪДДЩ                      АДДДДДДДД
   АДДДЩ

* RGB analog video
 ^R
          Ъ----------------------ї
          і±±±±±±±±±±±±±±±±±±±±±±і
          і±±±±±±±±±±±±±±±±±±±±±±і
 ДДДДДДДДДЩ                      АДДДДДДДД
 ^G
          Ъ----------------------ї
          і±±±±±±±±±±±±±±±±±±±±±±і
          і±±±±±±±±±±±±±±±±±±±±±±і
 ДДДДДДДДДЩ                      АДДДДДДДД
 ^B
          Ъ----------------------ї
          і±±±±±±±±±±±±±±±±±±±±±±і
          і±±±±±±±±±±±±±±±±±±±±±±і
 ДДДДДДДДДЩ                      АДДДДДДДД
---

## Act 2: Text Mode

* A Font is a collection of tiny bitmaps
* Code Pages vs Unicode
* Rendering to a bitmap or in real-time
---

## Act 2: Text Attributes

^e
ЪДДВДДВДДВДДВДДВДДВДДВДДї
і  і^GЫЫ^Wі^GЫЫ^Wі^GЫЫ^Wі^GЫЫ^Wі^GЫЫ^Wі  і  і
і  і^GЫЫ^Wі^GЫЫ^Wі^GЫЫ^Wі^GЫЫ^Wі^GЫЫ^Wі  і  і
ГДДЕДДЕДДЕДДЕДДЕДДЕДДЕДДґ
і^GЫЫ^Wі  і  і  і  і  і^GЫЫ^Wі  і
і^GЫЫ^Wі  і  і  і  і  і^GЫЫ^Wі  і
ГДДЕДДЕДДЕДДЕДДЕДДЕДДЕДДґ
і^GЫЫ^Wі  і  і^GЫЫ^Wі^GЫЫ^Wі  і^GЫЫ^Wі  і
і^GЫЫ^Wі  і  і^GЫЫ^Wі^GЫЫ^Wі  і^GЫЫ^Wі  і
ГДДЕДДЕДДЕДДЕДДЕДДЕДДЕДДґ
і^GЫЫ^Wі  і^GЫЫ^Wі  і  і  і^GЫЫ^Wі  і
і^GЫЫ^Wі  і^GЫЫ^Wі  і  і  і^GЫЫ^Wі  і
ГДДЕДДЕДДЕДДЕДДЕДДЕДДЕДДґ
і^GЫЫ^Wі  і^GЫЫ^Wі  і  і  і^GЫЫ^Wі  і
і^GЫЫ^Wі  і^GЫЫ^Wі  і  і  і^GЫЫ^Wі  і
ГДДЕДДЕДДЕДДЕДДЕДДЕДДЕДДґ
і^GЫЫ^Wі  і^GЫЫ^Wі  і  і  і^GЫЫ^Wі  і
і^GЫЫ^Wі  і^GЫЫ^Wі  і  і  і^GЫЫ^Wі  і
ГДДЕДДЕДДЕДДЕДДЕДДЕДДЕДДґ
і^GЫЫ^Wі  і  і^GЫЫ^Wі^GЫЫ^Wі  і^GЫЫ^Wі  і
і^GЫЫ^Wі  і  і^GЫЫ^Wі^GЫЫ^Wі  і^GЫЫ^Wі  і
ГДДЕДДЕДДЕДДЕДДЕДДЕДДЕДДґ
і^GЫЫ^Wі  і  і  і  і  і^GЫЫ^Wі  і
і^GЫЫ^Wі  і  і  і  і  і^GЫЫ^Wі  і
ГДДЕДДЕДДЕДДЕДДЕДДЕДДЕДДґ
і  і^GЫЫ^Wі^GЫЫ^Wі^GЫЫ^Wі^GЫЫ^Wі^GЫЫ^Wі  і  і
і  і^GЫЫ^Wі^GЫЫ^Wі^GЫЫ^Wі^GЫЫ^Wі^GЫЫ^Wі  і  і
АДДБДДБДДБДДБДДБДДБДДБДДЩ
---

## Agenda

* Act 1 - Embedded Rust
* Act 2 - The Idea
* Act 3 - The Implementation <--
* Act 4 - Spiralling out of control
* Act 5 - The Demo
---

## Act 2: Show me the source!

    ^Cfor^W (ch, attr) ^Cin^W row.glyphs.iter() {
      ^Clet^W index ^Y=^W (*ch ^Cas^W isize) ^Y*^W
        (MAX_FONT_HEIGHT ^Cas^W isize);
      ^Clet^W w ^Y=^W ^Cunsafe^W {
        *font_table.offset(index) };
      ^Clet^W rgb_addr ^Y=^W ^Cunsafe^W {
        RGB_MAPS
          .as_ptr()
          .offset(
            (
              (attr.0 ^Cas^W isize) ^Y*^W
              256_isize
            ) ^Y+^W (w ^Cas^W isize)
          )
      };
      ^Clet^W rgb_word ^Y=^W ^Cunsafe^W { *rgb_addr };
      hw.write_pixels(
        rgb_word ^Y>>^W 16,
        rgb_word ^Y>>^W 8,
        rgb_word
      );
    }
---

## Act 3: Implementation Failure...

 ^R
          Ъ----------------------ї
          і±±±±±±±±±±±±±±±±±±±±±±і
          і±±±±±±±±±±±±±±±±±±±±±±і
 ДДДДДДДДДБ----------------------БДДДДДДДДД
 ^G
              Ъ----------------------ї
              і±±±±±±±±±±±±±±±±±±±±±±і
              і±±±±±±±±±±±±±±±±±±±±±±і
 ДДДДДДДДДДДДДБ----------------------БДДДДД
 ^B
                  Ъ----------------------ї
                  і±±±±±±±±±±±±±±±±±±±±±±і
                  і±±±±±±±±±±±±±±±±±±±±±±і
 ДДДДДДДДДДДДДДДДДБ----------------------БД

* Fringing effect

   ^r  ^y  ^w           ^c  ^b  ^k
   ^r  ^y  ^w           ^c  ^b  ^k
   ^r  ^y  ^w           ^c  ^b  ^k
   ^r  ^y  ^w           ^c  ^b  ^k
   ^r  ^y  ^w           ^c  ^b  ^k
   ^r  ^y  ^w           ^c  ^b  ^k
---

# Act 3: Would you like to see a demo?
---

## Act 3: Serial Input

* Keyboards are tiny computers
* Talking to them is non-trivial
* So, I cheated...
---

## Act 3: Command Line Interface

* REPL?
* BASIC?
* Keep it simple...

Item {
  item_type: ItemType::Callback(beep),
  command: "beep",
  help: Some("<freq> <len>"),
},

> beep
Error: Not enough arguments

> beep 440 60
Playing 440 Hz for 60 frames
---

## Act 3: PS/2 Keyboard (fail!)

* Clock Signal (from Keyboard)
* Data Signal (bi-directional)
* Open-Collector (can hold clock low)
* Scan Codes, ugh!
* Interrupts @ 10 kHz are bad for video

---

# Act 3: Joystick
---

## Act 3: Memory Layout

     ^bЙНННННННННННННН»^k 0x8000_8000
     ^bє              є^k
     ^bє Application  є^k
     ^bє              є^k
     ^bМНННННННННННННН№^k 0x8000_2000
     ^bє              є^k
     ^bє stack        є^k
     ^bє              є^k
     ^bМНННННННННННННН№^k 0x8000_0xxx
     ^bє              є^k
     ^bє data / bss   є^k
     ^bє              є^k
     ^bИННННННННННННННј^k 0x8000_0000

     ^rЙНННННННННННННН»^k 0x0004_0000
     ^rє              є^k
     ^rє data         є^k
     ^rє              є^k
     ^rМНННННННННННННН№^k 0x0003_8xxx
     ^rє              є^k
     ^rє rodata       є^k
     ^rє              є^k
     ^rМНННННННННННННН№^k 0x0002_xxxx
     ^rє              є^k
     ^rє text         є^k
     ^rє              є^k
     ^rМНННННННННННННН№^k 0x0000_0200
     ^rє vector       є^k
     ^rИННННННННННННННј^k 0x0000_0000
---

## Act 3: Application Binary Interface

* 0x2000 - 0x2003: Pointer to init fn
* 0x2004 - 0x2FFF: Don't care!
* Structure of function pointers
---

## Act 3: Application Binary Interface

* putchar(char) -> int
* puts(const char*) -> int
* readc() -> int
* wfvbi()
* kbhit() -> int
* move_cursor(row, col)
* play(freq, chan, wave, vol) -> int
* change_font(font)
* get_joystick() -> u8
* set_cursor_visible(bool)

---

## Act 3: Audio

* Square Wave Beeps

     ЪДДДДДДї     ЪДДДДДДї     ЪДДДДДДї     ЪД
     і      і     і      і     і      і     і
     і      і     і      і     і      і     і
ДДДДДЩ      АДДДДДЩ      АДДДДДЩ      АДДДДДЩ

* PWM and Audio Filter

     ЪДДДї        ЪДДДї        ЪДДДї        Ъ
     і   і        і   і        і   і        і
     і   і        і   і        і   і        і
ДДДДДЩ   АДДДДДДДДЩ   АДДДДДДДДЩ   АДДДДДДДДЩ

* Basic Tunes

* Three-channel wavetable synthesiser

* Tested on Linux with Pulse Audio

---

## Act 3: Storage Options
^K
      ^r                                ^k
      ^r     ^w                       ^r     ^k
      ^r     ^w                 ^r   ^w   ^r      ^k
      ^r     ^w                 ^r   ^w   ^r      ^k
      ^r     ^w                 ^r   ^w   ^r      ^k
      ^r     ^w                 ^r   ^w   ^r      ^k
      ^r     ^w                 ^r   ^w   ^r      ^k
      ^r     ^w                 ^r   ^w   ^r      ^k
      ^r     ^w                 ^r   ^w   ^r      ^k
      ^r     ^w                 ^r   ^w   ^r      ^k
      ^r     ^w                       ^r      ^k
      ^r     ^w                       ^r      ^k
      ^r                                  ^k
      ^r                                  ^k
      ^r                                  ^k
      ^r                                  ^k
      ^r  ^w                            ^r    ^k
      ^r  ^w                            ^r    ^k
      ^r  ^w 3.5 inch Floppy Disks      ^r    ^k
      ^r  ^w                            ^r    ^k
      ^r  ^w                            ^r    ^k
      ^r  ^w held 720 KiB or 1440 KiB   ^r    ^k
      ^r  ^w                            ^r    ^k
      ^r  ^w                            ^r    ^k
      ^r  ^w of data.                   ^r    ^k
      ^r  ^w                            ^r ^k  ^r ^k
      ^r  ^w                            ^r ^k  ^r ^k
      ^r  ^w                            ^r    ^k
      ^r                                  ^k
---

## Act 3: Microsoft FAT Filesystems

   ^rЙННННННННННН»^k N   ^bЙНННННННННН»^k M
   ^rє           є^k     ^bєFile A    є^k
   ^rє           є^k     ^bМНННННННННН№^k
   ^r|           |^k     ^b|          |^k
   ^rє           є^k     ^bМНННННННННН№^k
   ^rє           є^k     ^bєSpace     є^k
   ^rє           є^k     ^bМНННННННННН№^k
   ^rє           є^k     ^bє          є^k
   ^rє           є^k     ^bєFile A    є^k
   ^rєPartition 1є^k     ^bє          є^k
   ^rє           є^k     ^bМНННННННННН№^k
   ^rє           є^k     ^bє          є^k
   ^rє           є^k     ^bєRoot Dir  є^k
   ^rє           є^k     ^bє          є^k
   ^rє           є^k     ^bМНННННННННН№^k
   ^rє           є^k     ^bє          є^k
   ^rє           є^k     ^bєFAT       є^k
   ^rє           є^k     ^bє          є^k
   ^rє           є^k     ^bМНННННННННН№^k 1
   ^rє           є^k     ^bєVBR / BPB є^k
   ^rМННННННННННН№^k 32  ^bИННННННННННј^k 0
   ^rєReserved   є^k
   ^rМННННННННННН№^k 1
   ^rєMBR        є^k
   ^rИНННННННННННј^k 0

---

## Act 3: SD Card

* Appear as an array of 512-byte blocks
* Can be partitioned (or not)
* Can work in SPI mode (slowly)

           ЪДДДДДДДДДДДДДДДДДї
           і                 АДї
           і            N/C ^YЯЯЯ^WАДї
           і             CS   ^YЯЯЯ^Wі
           і             MOSI ^YЯЯЯ^Wі
           і             GND  ^YЯЯЯ^Wі
           і             VCC  ^YЯЯЯ^Wі
           і             SCK  ^YЯЯЯ^Wі
           і             GND  ^YЯЯЯ^Wі
           і             MISO ^YЯЯЯ^Wі
           і             N/C  ^YЯЯЯ^Wі
           АДДДДДДДДДДДДДДДДДДДДДЩ

* Super cheap!
* GH: thejpster/embedded-sdmmc-rs

---

## Agenda

* Act 1 - Embedded Rust
* Act 2 - The Idea
* Act 3 - The Implementation
* Act 4 - Spiralling out of control <--
* Act 5 - The Demo
---

# Act 4: Demo veroboard
---

## Act 4: Designing a PCB

* Is...
* ...hard
* ...really time consuming
* ...an open-ended project
* ...quite good fun?

---

## Act 4: RS-232 Serial Port

* It's not a DB9!
* +/- 5V to 15V signalling
* RX / TX / GND
* RTS / CTS
* DTR / DSR
* RI / DCD

* Could hook up old Modems?
* Serial mice?
* Linux on Monotron!

---

## Act 4: MIDI Port

* Atari ST had one...
* MIDI is just a UART!
* 31,250 bps
* 5V signalling, opto-isolated

---

## Act 4: Real Time Clocks

* CMOS Batteries
* TM4C has one...
* ... but no coin cell input
* Crystal capacitance is fun
* Inter-Integrated Circuit / TWI
* Sec/Min/Hour/DOW/Day/Month/Year

---

## Act 4: Keyboards, revisited

* Can't do 10 kHz data AND video
* How did IBM solve this?
* Intel i8042
* I could add an I/O processor!

---

## Act 4: AtMega 328

               ЙНННННННННННННН»^k
           ^mPC6^k-є              є^k-^mPC5^k
           ^r RX^k-є              є^k-^mPC4^k
           ^r TX^k-є              є^k-^mPC3^k
           ^rPD2^k-є              є^k-^mPC2^k
           ^rPD3^k-є              є^k-^mPC1^k
           ^rPD4^k-є              є^k-^mPC0^k
           Vcc-є              є^k-GND
           GND-є              є^k-ARef
           ^bPB7^k-є              є^k-Vcc
           ^bPB6^k-є              є^k-^bPB5^k
           ^rPD5^k-є              є^k-^bPB4^k
           ^rPD6^k-є              є^k-^bPB3^k
           ^rPD7^k-є              є^k-^bPB2^k
           ^bPB0^k-є              є^k-^bPB1^k
               ИННННННННННННННј^k

* 23 pins ...
* (If you include RST and XTAL1/2)

---

## Act 4: IEEE-1284 Parallel Port
                       ЪДДДДї
                  ЪДДДДЩ  o і^mSEL ^k
               GNDі  o      і
                  і       o і^mPE  ^k
               GNDі  o      і
                  і       o і^mBUSY^k
               GNDі  o      і
                  і       o і^mACK ^k
               GNDі  o      і
                  і       o і^rD7 ^k
               GNDі  o      і
                  і       o і^rD6 ^k
               GNDі  o      і
                  і       o і^rD5 ^k
               GNDі  o      і
                  і       o і^rD4 ^k
               GNDі  o      і
                  і       o і^rD3 ^k
             ^bSELIN^kі  o      і
                  і       o і^rD2 ^k
             ^b INIT^kі  o      і
                  і       o і^rD1 ^k
             ^mERROR^kі  o      і
                  і       o і^rD0 ^k
             ^bAUTOF^kі  o      і
                  АДДДДДї o і^bSTRB^k
                        АДДДЩ
---

## Act 4: Inventing a programming language

* BASIC
* Python
* Javascript
* Pascal
* REXX
* Euphoria

---

## Act 4: Monotronian


01 ^Cfn^W main(args)
02    len ^Y=^W length(args)
03    ^Cfor^W x ^Y=^W 1 ^Cto^W len
04        ^Cif^W args[x] ^Y==^W ^G"--help"^W
05            print_help()
06            ^Creturn^W
07        ^Celif^W args[x] ^Y==^W ^G"--verbose"^W
08            verbose ^Y=^W verbose ^Y+^W 1
09        ^Celse^W
10            process_file(args[x])
11        ^Cendif^W
12    ^Cendfor^W
13 ^Cendfn^W
---

## Act 4: Closing Thoughts

* github.com/thejpster
* keybase.io/thejpster
* Come say hi!
* (I have Rust Embedded flyers)
* Think about how you write code
---

## Agenda

* Act 1 - Embedded Rust
* Act 2 - The Idea
* Act 3 - The Implementation
* Act 4 - Spiralling out of control
* Act 5 - The Demo <--
---
